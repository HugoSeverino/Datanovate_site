<div class="flex flex-col justify-evenly items-center min-w-[85vw] space-y-4 content overflow-hidden">
    <div class="flex flex-col justify-between items-center p-4 bg-white shadow-lg rounded-lg text-center">
        <h2 class="text-2xl font-bold mb-4 text-gray-700">‚úçÔ∏è Dessinez un chiffre</h2>

        <div class="relative group">
            <canvas 
            id="canvas" 
            width="280" 
            height="280"
            class="w-full h-auto border-4 border-gray-300 rounded-xl shadow-md cursor-crosshair bg-white group-hover:border-blue-200 group-hover:shadow-lg"
            ></canvas>
        </div>

        <div class="flex flex-row justify-center space-x-4 mt-4">
            <button onclick="clearCanvas()" type="button" class="px-6 py-2.5 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 hover:shadow-lg flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Effacer
            </button>
        </div>
        
        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
            <p id="rep" class="text-xl font-bold text-blue-600 text-center">Pr√™t √† deviner !</p>
        </div>

        <button id="detailsButton" onclick="showDetails()" type="button" class="mt-2 px-4 py-2 bg-blue-300 text-blue-800 font-semibold rounded-lg shadow-md hover:bg-blue-400 hover:shadow-lg hidden">
            D√©tails
        </button>
    </div>

    <div id="flecheButton" class="">
        <button onclick="hideDetails()">
            <svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14M12 5l7 7-7 7"></path>
            </svg>   
        </button>     
    </div>

    <div class="bg-white shadow-lg rounded-lg text-center w-[100%] space-x-3">
        <h2 class="text-2xl font-bold mb-4 text-gray-700">R√©seau de neurones</h2>

        <div class="flex flex-row items-center justify-between text-gray-700">
            <div class="">
                <h3 class="text-xl font-bold mb-4">Image normalis√©e</h3>
                <div>
                    <div class="flex items-center">
                        <div class="min-w-[70px] mr-4"></div>
                        <p>28</p>
                    </div>
                    <div class="flex items-center">
                        <p class="mr-2">28</p>
                        <img id="image" class="min-w-[140px] min-h-[140px] max-w-[140px] bg-white border border-gray-400" src="" alt=""/>
                    </div>
                </div>
            </div>
            <div class="flex flex-col shadow-xl rounded-lg p-4">
                <h3 class="text-xl font-bold mb-4">Convolutions</h3>
                <div class="flex items-center space-x-4">
                    <div class="w-[50px] h-[50px] [perspective:1000px]">
                        <!-- Conteneur du cube -->
                        <div class="absolute top-1/2 left-1/4 [transform-style:preserve-3d] [transform:translate(-50%,_-50%)_rotateX(-30deg)_rotateY(45deg)]">
                          <!-- Face avant -->
                          <div class="box [transform:rotateY(-100deg)_translateZ(14px)] bg-[#ff0000] w-[28px] h-[28px]">
                          </div>
                          <!-- Face droite -->
                          <div class="box [transform:rotateY(-10deg)_translateZ(14px)] foo w-[28px] h-[28px]">
                          </div>
                          <!-- Face sup√©rieure -->
                          <div class="box [transform:rotateY(-10deg)_rotateX(90deg)_translateZ(14px)] foo w-[28px] h-[28px]">
                          </div>
                        </div>
                    </div>
                    <div class="w-[80px] h-[50px] [perspective:1000px]">
                        <!-- Conteneur du cube -->
                        <div class="absolute top-[75%] left-[12.5%] [transform-style:preserve-3d] [transform:translate(-50%,_-50%)_rotateX(-30deg)_rotateY(45deg)]">
                            <!-- Face avant -->
                            <div class="box [transform:rotateY(-100deg)_translateZ(7px)_translateX(-4px)] bg-[#ff0000] w-[14px] h-[14px]">
                            </div>
                            <!-- Face droite -->
                            <div class="box [transform:rotateY(-10deg)_translateZ(7px)] foo w-[64px] h-[14px]">
                            </div>
                            <!-- Face sup√©rieure -->
                            <div class="box [transform:rotateY(-10deg)_rotateX(90deg)_translateZ(7px)] foo w-[64px] h-[14px]">
                            </div>
                        </div>
                    </div>
                    <div class="w-[130px] h-[50px] [perspective:1000px]">
                        <!-- Conteneur du cube -->
                        <div class="absolute top-[100%] left-0 [transform-style:preserve-3d] [transform:translate(-50%,_-50%)_rotateX(-30deg)_rotateY(45deg)]">
                            <!-- Face avant -->
                            <div class="box [transform:rotateY(-100deg)_translateZ(4px)_translateX(-10px)] bg-[#ff0000] w-[7px] h-[7px]">
                            </div>
                            <!-- Face droite -->
                            <div class="box [transform:rotateY(-10deg)_translateZ(4px)] foo w-[128px] h-[7px]">
                            </div>
                            <!-- Face sup√©rieure -->
                            <div class="box [transform:rotateY(-10deg)_rotateX(90deg)_translateZ(4px)_translateY(1px)] foo w-[128px] h-[7px]">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col shadow-lg rounded-lg p-3 ">
                <h3 class="text-xl font-bold mb-4">Reshape</h3>
                <p>128</p>
                
                <div class="flex space-x-1">
                    <p>9</p>
                    <img id="after_reshape" src="" alt="" class="h-[27px] min-w-[384px] max-w-[384px]">
                </div>
            </div>

            <div class="flex flex-col shadow-lg rounded-lg bg-opacity-50 p-4">
                <h3 class="text-xl font-bold mb-4">Couches cach√©es</h3>
                <div class="flex">
                    <div class="flex flex-col bg-blue-500 shadow-lg opacity-50 p-2">
                        
                    </div>
                    <div>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>
            </div>

            <div class="flex flex-col shadow-lg rounded-lg p-4 relative">
                <h3 class="text-xl font-bold mb-10">Couches de sortie</h3>
                <div class="flex justify-center">
                    <div class="flex flex-col items-center justify-evenly space-y-6">
                        {% for i in range(10) %}
                            <div id="neuron_{{ i }}" class="relative w-7 h-7 bg-green-500 shadow-lg rounded-lg"></div>
                        {% endfor %}
                    </div>
                </div>
                <div class="absolute h-[100%]">
                    <svg width="275" class="h-[100%]" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">
                        <defs>
                            <marker id="arrowhead" markerHeight="7" markerWidth="10" orient="0" refX="8.5" refY="3.5">
                                <polygon fill="black" points="0 0, 10 3.5, 0 7"/>
                            </marker>
                        </defs>
                        <g class="layer">
                            {% for i in range(10) %}
                                <!-- Calcul des positions des lignes -->
                                <path d="M100,{{ 81 + i * 52 }} C140,{{ 81 + i * 52 }}, 150,{{ 68 + i * 52 }}, 211,{{ 70 + i * 52 }}"
                                    fill="transparent"
                                    marker-end="url(#arrowhead)"
                                    stroke="black"
                                    stroke-width="2"/>
                            {% endfor %}
                        </g>
                    </svg>
                </div>
            </div>
            
            <!-- Bloc D√©tails -->
            <div id="details" class="bg-white p-4 rounded-lg shadow-lg w-[240px]">
                <h3 class="text-gray-700 text-2xl font-semibold mb-4">üìä Pr√©dictions</h3>
                <ul class="text-white text-lg space-y-2">
                    {% for i in range(10) %}
                        <li id="li_{{ i }}" class="bg-white text-gray-900 px-4 py-2 rounded-lg shadow text-left">Chiffre {{i}} : 0%
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>


<script>
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let drawing = false;
    let autoSendInterval = null;

    ctx.fillStyle = "rgba(255, 255, 255, 1)";
    ctx.fillRect(0, 0, canvas.width, canvas.height); // Fond blanc

    canvas.addEventListener("mousedown", () => {
                lastX = event.offsetX;
                lastY = event.offsetY; 
                drawing = true;
                sendDrawing();
                });
    canvas.addEventListener("mouseup", () => { 
                sendDrawing();
                drawing = false;});
    canvas.addEventListener("mousemove", draw);

    let lastX = 0;
    let lastY = 0;

    function draw(event) {
        if (!drawing) return;

        ctx.fillStyle = "black";  // Couleur des points
        const pointSize = 4;  // Taille des points
    
        // Si c'est le premier mouvement, on initialise les coordonn√©es
        if (lastX === 0 && lastY === 0) {
            lastX = event.offsetX;
            lastY = event.offsetY;
        }
    
        // Calculer les diff√©rences entre les positions pour tracer plusieurs points
        const dx = event.offsetX - lastX;
        const dy = event.offsetY - lastY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // Nombre de points √† dessiner entre lastX, lastY et la position actuelle
        const pointsCount = Math.floor(distance); // Ajuster la valeur pour avoir plus ou moins de points
    
        // Dessiner plusieurs points pour cr√©er un effet de trait
        for (let i = 0; i < pointsCount; i++) {
            const x = lastX + (dx * i) / pointsCount;
            const y = lastY + (dy * i) / pointsCount;
    
            ctx.beginPath();
            ctx.arc(x, y, pointSize, 0, Math.PI * 2);  // Dessiner un point
            ctx.fill();
        }
    
        // Mettre √† jour les coordonn√©es pour le prochain mouvement
        lastX = event.offsetX;
        lastY = event.offsetY;
    }

    function clearCanvas() {
        ctx.fillStyle = "rgba(255, 255, 255, 1)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        document.getElementById("rep").textContent = "Pr√™t √† deviner !";
        document.getElementById("image").src = "";
        for (let i = 0; i < 10; i++) {
            document.getElementById("li_" + i).innerText = "Chiffre " + i + " : 0%";
        }
    }

    function sendDrawing() {
        let dataURL = canvas.toDataURL("image/png");

        fetch("/save_drawing", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: dataURL })
        })
        .then(response => response.json())
        .then(data => {
            // Remplacer le contenu de la div avec l'ID 'message' par le message du serveur
            document.getElementById("rep").textContent = "C'est un " + data.predict;

            for (let i = 0; i < data.predict_probas.length; i++) {
                text = "Chiffre " + i + " : " + Math.round(data.predict_probas[i] * 100 * 100)/100 + "%"; 
                document.getElementById("li_" + i).innerText = text;
            }
            time = new Date().getTime();
            document.getElementById("image").src = "../static/img/enlarged_chiffre_norm.png?timestamp=" + time; // timestamp pour l'actualisation automatique de l'image
            document.getElementById("after_reshape").src = "../static/img/after_reshape.png?timestamp=" + time;
            if (drawing) {
                sendDrawing();
            }
        })
        .catch(error => console.error("Erreur:", error));
    }

    function showDetails() {
        document.getElementById('details').classList.remove('hidden');
        document.getElementById('flecheButton').classList.remove('hidden');
        document.getElementById('detailsButton').classList.add('hidden');
    }

    function hideDetails() {
        document.getElementById('details').classList.add('hidden');
        document.getElementById('flecheButton').classList.add('hidden');
        document.getElementById('detailsButton').classList.remove('hidden');
    }

</script>